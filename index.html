<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIBS AI PathFinder - Intelligent Program Advisor</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF.js for CV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        /* Header */
        header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 60px;
        }
        .logo-container .logo {
            height: 40px;
            width: auto;
            transition: transform 0.3s ease;
        }
        .logo:hover {
            transform: scale(1.05);
        }
        nav ul {
            display: flex;
            list-style: none;
            gap: 25px;
        }
        nav a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            font-size: 14px;
            padding: 8px 0;
            transition: color 0.3s ease;
            position: relative;
            text-transform: capitalize;
        }
        nav a:hover {
            color: #20409a;
        }
        nav a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: #20409a;
            transition: width 0.3s ease;
        }
        nav a:hover::after {
            width: 100%;
        }
        /* Main Layout */
        .main-container {
            display: flex;
            min-height: calc(100vh - 120px);
        }
        /* Left Sidebar - Chat Interface */
        .chat-sidebar {
            width: 40%;
            background: white;
            border-right: 1px solid #eaeaea;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 20px;
            background: #20409a;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
        }
        .chat-header i {
            font-size: 20px;
        }
        .session-controls {
            display: flex;
            gap: 10px;
        }
        .session-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }
        .session-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .chat-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #fafafa;
        }
        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .message.bot {
            background: white;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid #eaeaea;
        }
        .message.user {
            background: #20409a;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .message.system {
            background: #fff8e1;
            color: #333;
            align-self: center;
            text-align: center;
            font-size: 14px;
            font-style: italic;
            border-radius: 8px;
            max-width: 90%;
            border: 1px solid #ffecb3;
        }
        .message-info {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
            display: flex;
            justify-content: flex-end;
        }
        .chat-footer {
            padding: 20px;
            border-top: 1px solid #eaeaea;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: white;
        }
        .input-container {
            display: flex;
            gap: 10px;
        }
        .chat-footer input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            outline: none;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
        }
        .chat-footer button {
            padding: 12px 24px;
            background: #20409a;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
            min-width: 100px;
        }
        .chat-footer button:hover {
            background: #1a357f;
        }
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .quick-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }
        .quick-btn:hover {
            background: #20409a;
            color: white;
        }
        .upload-btn {
            background: #4CAF50;
            color: white;
        }
        .upload-btn:hover {
            background: #45a049;
        }
        /* Right Content Area */
        .content-area {
            width: 60%;
            padding: 30px;
            overflow-y: auto;
            background: white;
        }
        .content-area h1 {
            color: #1a1a1a;
            margin-bottom: 25px;
            font-size: 28px;
            padding-bottom: 15px;
            border-bottom: 2px solid #20409a;
        }
        .content-area h1 .accent {
            color: #20409a;
        }
        /* Sections */
        .content-section {
            margin-bottom: 40px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Analysis Sections */
        .analysis-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #20409a;
        }
        .analysis-box h3 {
            color: #20409a;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .analysis-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #eaeaea;
        }
        .profile-item {
            display: flex;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        .profile-label {
            font-weight: 600;
            width: 150px;
            color: #555;
        }
        .profile-value {
            flex: 1;
            color: #333;
        }
        /* CV Upload Area */
        .cv-upload-area {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        .cv-upload-area:hover {
            border-color: #20409a;
            background: #f0f7ff;
        }
        .cv-upload-area i {
            font-size: 48px;
            color: #20409a;
            margin-bottom: 15px;
        }
        .cv-upload-area h3 {
            color: #333;
            margin-bottom: 10px;
        }
        .cv-upload-area p {
            color: #666;
            font-size: 14px;
        }
        .file-preview {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 8px;
            border: 1px solid #c8e6c9;
        }
        /* Program Cards */
        .programs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .program-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #eaeaea;
        }
        .program-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .program-card h3 {
            color: #20409a;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .program-meta {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        .program-card p {
            color: #555;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .program-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        .tag {
            background: #eef2ff;
            color: #20409a;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .program-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        /* Footer */
        footer {
            background-color: #1a1a1a;
            padding: 25px 0;
            text-align: center;
            border-top: 1px solid #333;
        }
        footer p {
            color: #aaa;
            font-size: 13px;
        }
        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }
            .chat-sidebar, .content-area {
                width: 100%;
            }
            .chat-sidebar {
                height: 60vh;
            }
            .programs-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            nav ul {
                display: none;
            }
            .chat-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            .session-controls {
                width: 100%;
                justify-content: center;
            }
        }
        /* Loading Animation */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #20409a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 10px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #20409a;
            border-radius: 50%;
            opacity: 0.6;
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        /* Utility Classes */
        .hidden {
            display: none;
        }
        .text-success {
            color: #4CAF50;
        }
        .text-warning {
            color: #ff9800;
        }
        .text-error {
            color: #f44336;
        }
        .btn-primary {
            background: #20409a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-primary:hover {
            background: #1a357f;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-container">
                    <a href="#">
                        <img src="logo2.png" alt="GIBS AI PathFinder Logo" class="logo">
                    </a>
                </div>
                <nav>
                    <ul>
                        <li><a href="#chat">AI Advisor</a></li>
                        <li><a href="#analysis">CV Analysis</a></li>
                        <li><a href="#programs">Programs</a></li>
                        <li><a href="#career">Career</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Left Sidebar - Chat Interface -->
        <div class="chat-sidebar">
            <div class="chat-header">
                <h2><i class="fas fa-robot"></i> GIBS AI PathFinder</h2>
                <div class="session-controls">
                    <button class="session-btn" onclick="clearSession()"><i class="fas fa-redo"></i> New Session</button>
                    <button class="session-btn" onclick="exportSessionData()"><i class="fas fa-download"></i> Export</button>
                </div>
            </div>
            <div class="chat-body" id="chatBody">
                <!-- Messages will be loaded here -->
            </div>
            <div class="chat-footer">
                <div class="input-container">
                    <input type="text" id="userInput" placeholder="Ask about GIBS programs, admissions, career paths..." onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()">Send</button>
                </div>
                <div class="quick-actions">
                    <button class="quick-btn" onclick="quickAction('cv')"><i class="fas fa-file-upload"></i> Upload CV</button>
                    <button class="quick-btn" onclick="quickAction('programs')">Programs</button>
                    <button class="quick-btn" onclick="quickAction('admissions')">Admissions</button>
                    <button class="quick-btn" onclick="quickAction('career')">Career Advice</button>
                    <button class="quick-btn" onclick="quickAction('cost')">Costs & Funding</button>
                </div>
            </div>
        </div>

        <!-- Right Content Area -->
        <div class="content-area">
            <h1>GIBS AI <span class="accent">PathFinder</span> <small style="font-size: 14px; color: #666;">| Intelligent Educational Advisor</small></h1>
            
            <!-- CV Upload & Analysis Section -->
            <div class="content-section" id="analysis">
                <div class="analysis-box">
                    <h3><i class="fas fa-file-medical-alt"></i> CV Analysis & Personalization</h3>
                    <div class="cv-upload-area" onclick="document.getElementById('cvFileInput').click()" id="cvUploadZone">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>Upload Your CV for Personalized Analysis</h3>
                        <p>Drag & drop or click to upload your CV (PDF, DOC, DOCX, TXT)</p>
                        <p style="font-size: 12px; color: #888; margin-top: 10px;">We'll analyze your experience, skills, and qualifications</p>
                    </div>
                    <input type="file" id="cvFileInput" accept=".pdf,.doc,.docx,.txt" style="display:none">
                    
                    <div id="cvAnalysisResult" class="analysis-content">
                        <!-- CV analysis results will appear here -->
                    </div>
                </div>
                
                <!-- Profile Summary -->
                <div class="analysis-box" id="profileSection" style="display: none;">
                    <h3><i class="fas fa-user-circle"></i> Your Profile Summary</h3>
                    <div class="analysis-content" id="profileContent">
                        <!-- Profile content will appear here -->
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn-primary" onclick="askAboutProfileCorrection()"><i class="fas fa-edit"></i> Correct Profile Details</button>
                        <button class="btn-primary" onclick="getProgramRecommendations()" style="margin-left: 10px;"><i class="fas fa-graduation-cap"></i> Get Program Recommendations</button>
                    </div>
                </div>
            </div>

            <!-- Program Recommendations -->
            <div class="content-section" id="recommendationsSection" style="display: none;">
                <div class="analysis-box">
                    <h3><i class="fas fa-star"></i> Recommended GIBS Programs</h3>
                    <div id="programRecommendations" class="analysis-content">
                        <!-- Program recommendations will appear here -->
                    </div>
                </div>
            </div>

            <!-- Career Opportunities -->
            <div class="content-section" id="careerSection" style="display: none;">
                <div class="analysis-box">
                    <h3><i class="fas fa-briefcase"></i> Career Opportunities & Pathways</h3>
                    <div id="careerOpportunities" class="analysis-content">
                        <!-- Career info will appear here -->
                    </div>
                </div>
            </div>

            <!-- All Programs -->
            <div class="content-section" id="programsSection">
                <div class="analysis-box">
                    <h3><i class="fas fa-graduation-cap"></i> GIBS Academic Programs</h3>
                    <div class="programs-grid" id="programsGrid">
                        <!-- Programs will be dynamically loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2025 GIBS AI PathFinder. All rights reserved.</p>
            <p>Gordon Institute of Business Science, University of Pretoria | Triple Crown Accredited (AACSB, AMBA, EQUIS)</p>
            <p style="margin-top: 10px; font-size: 12px; color: #777;">This AI assistant provides guidance based on publicly available information. For official admissions advice, please contact GIBS directly.</p>
        </div>
    </footer>

    <script>
        // Configuration
        const GROK_API_KEYS = [
            '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',
            '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',
            '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'
        ];
        let currentApiKeyIndex = 0;
        let conversationHistory = [];
        let userProfile = null;
        let currentCVText = '';

        // Session Management
        let currentSession = {
            id: generateSessionId(),
            messages: [],
            profile: null,
            cvData: null,
            timestamp: new Date().toISOString()
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initSession();
            loadPrograms();
            setupEventListeners();
            addWelcomeMessage();
        });

        function initSession() {
            // Try to load existing session
            try {
                const savedSession = localStorage.getItem('gibs_session');
                if (savedSession) {
                    currentSession = JSON.parse(savedSession);
                    
                    // Restore conversation history
                    currentSession.messages.forEach(msg => {
                        conversationHistory.push(msg);
                        if (msg.role === 'assistant' || msg.role === 'user') {
                            addMessageToChat(msg.role, msg.content);
                        }
                    });
                    
                    // Restore profile
                    if (currentSession.profile) {
                        userProfile = currentSession.profile;
                        displayProfileSummary();
                    }
                    
                    document.getElementById('sessionId').textContent = currentSession.id.substring(0, 8);
                    updateMessageCount();
                }
            } catch (e) {
                console.log('Starting fresh session');
                currentSession.id = generateSessionId();
            }
        }

        function generateSessionId() {
            return 'gibs_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function setupEventListeners() {
            // CV file input
            document.getElementById('cvFileInput').addEventListener('change', handleCVUpload);
            
            // Drag and drop for CV
            const uploadZone = document.getElementById('cvUploadZone');
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = '#20409a';
                uploadZone.style.background = '#f0f7ff';
            });
            
            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = '#ddd';
                uploadZone.style.background = '#f8f9fa';
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = '#ddd';
                uploadZone.style.background = '#f8f9fa';
                
                if (e.dataTransfer.files.length) {
                    document.getElementById('cvFileInput').files = e.dataTransfer.files;
                    handleCVUpload({ target: document.getElementById('cvFileInput') });
                }
            });
            
            // Enter key in chat
            document.getElementById('userInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        function addWelcomeMessage() {
            if (conversationHistory.length === 0) {
                setTimeout(() => {
                    addBotMessage("Hello! I'm your GIBS AI PathFinder Assistant. I can help you with:\n\n• Finding the perfect GIBS program for your career goals\n• Analyzing your CV for personalized recommendations\n• Information on admissions, costs, and requirements\n• Career opportunities and pathways after GIBS\n\nHow can I assist you today?");
                }, 500);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const userMessage = input.value.trim();
            
            if (!userMessage) return;
            
            // Add user message to chat
            addUserMessage(userMessage);
            input.value = '';
            
            // Save to conversation history
            const userMsg = { role: 'user', content: userMessage, timestamp: new Date().toISOString() };
            conversationHistory.push(userMsg);
            currentSession.messages.push(userMsg);
            
            // Show typing indicator
            const typingMsg = addTypingIndicator();
            
            try {
                // Prepare context for AI
                const context = prepareContextForAI(userMessage);
                
                // Call AI API
                const response = await callAIAPI(userMessage, context);
                
                // Remove typing indicator
                typingMsg.remove();
                
                // Add bot response
                addBotMessage(response);
                
                // Save to history
                const botMsg = { role: 'assistant', content: response, timestamp: new Date().toISOString() };
                conversationHistory.push(botMsg);
                currentSession.messages.push(botMsg);
                
                // Update session storage
                saveSession();
                updateMessageCount();
                
                // Analyze response for actions
                analyzeResponseForActions(userMessage, response);
                
            } catch (error) {
                typingMsg.remove();
                addBotMessage("I apologize, but I encountered an error processing your request. Please try again or rephrase your question.");
                console.error('API Error:', error);
                
                // Rotate API key on error
                currentApiKeyIndex = (currentApiKeyIndex + 1) % GROK_API_KEYS.length;
            }
        }

        function prepareContextForAI(userMessage) {
            // Build context from conversation history and user profile
            let context = "You are the GIBS AI PathFinder Assistant, an expert on Gordon Institute of Business Science (GIBS) at University of Pretoria.\n\n";
            
            context += "IMPORTANT FACTS ABOUT GIBS:\n";
            context += "- GIBS is triple-accredited (AACSB, AMBA, EQUIS)\n";
            context += "- Located in Illovo, Johannesburg, South Africa\n";
            context += "- Focuses on African business leadership and development\n";
            context += "- Offers MBA, PDBA, MPhil, DBA, PhD, and executive programs\n";
            context += "- Strong emphasis on ethics, entrepreneurship, and responsible leadership\n\n";
            
            // Add user profile context if available
            if (userProfile) {
                context += "USER PROFILE:\n";
                if (userProfile.experience) context += `- Experience: ${userProfile.experience}\n`;
                if (userProfile.education) context += `- Education: ${userProfile.education}\n`;
                if (userProfile.skills) context += `- Skills: ${userProfile.skills}\n`;
                if (userProfile.industry) context += `- Industry: ${userProfile.industry}\n`;
                if (userProfile.goals) context += `- Goals: ${userProfile.goals}\n`;
                context += "\n";
            }
            
            // Add recent conversation context (last 6 messages)
            const recentHistory = conversationHistory.slice(-6);
            if (recentHistory.length > 0) {
                context += "RECENT CONVERSATION:\n";
                recentHistory.forEach(msg => {
                    const role = msg.role === 'user' ? 'User' : 'Assistant';
                    context += `${role}: ${msg.content}\n`;
                });
                context += "\n";
            }
            
            context += "INSTRUCTIONS:\n";
            context += "- Provide accurate, factual information about GIBS\n";
            context += "- If discussing programs, mention duration, level, and typical outcomes\n";
            context += "- For career advice, be realistic about opportunities\n";
            context += "- If you don't know something, admit it and suggest where to find info\n";
            context += "- Be professional but conversational\n";
            context += "- Format responses with clear paragraphs and bullet points when helpful\n";
            
            return context;
        }

        async function callAIAPI(userMessage, context) {
            const apiKey = GROK_API_KEYS[currentApiKeyIndex];
            
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'mixtral-8x7b-32768',
                    messages: [
                        {
                            role: 'system',
                            content: context
                        },
                        {
                            role: 'user',
                            content: userMessage
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 1500,
                    stream: false
                })
            });
            
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function handleCVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Show upload status
            addSystemMessage(`Uploading CV: ${file.name}...`);
            
            try {
                // Extract text from CV
                const cvText = await extractTextFromFile(file);
                
                if (!cvText || cvText.trim().length < 50) {
                    addBotMessage("I couldn't extract meaningful text from your CV. The file might be scanned or in an unsupported format. You can:\n\n1. Tell me about your experience, education, and career goals\n2. Upload a different CV file (PDF, DOC, DOCX, or TXT)\n3. Or ask me specific questions about GIBS programs");
                    return;
                }
                
                // Store CV text (limit to 2000 chars)
                currentCVText = cvText.substring(0, 2000);
                currentSession.cvData = currentCVText;
                
                // Analyze CV with AI
                addSystemMessage("Analyzing your CV...");
                const analysis = await analyzeCVWithAI(cvText);
                
                // Update user profile
                userProfile = analysis;
                currentSession.profile = analysis;
                
                // Save session
                saveSession();
                
                // Display profile summary
                displayProfileSummary();
                
                // Ask user to verify/correct
                await askForProfileVerification(analysis);
                
            } catch (error) {
                addBotMessage("Sorry, I had trouble processing your CV. Please try uploading a different file, or simply tell me about your background and career goals.");
                console.error('CV processing error:', error);
            }
        }

        async function extractTextFromFile(file) {
            return new Promise((resolve, reject) => {
                if (file.type === 'application/pdf') {
                    // Use PDF.js for PDF files
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const pdfData = new Uint8Array(e.target.result);
                            const pdf = await pdfjsLib.getDocument({data: pdfData}).promise;
                            let fullText = '';
                            
                            // Limit to first 5 pages for performance
                            const pageLimit = Math.min(pdf.numPages, 5);
                            for (let i = 1; i <= pageLimit; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                const pageText = textContent.items.map(item => item.str).join(' ');
                                fullText += pageText + '\n';
                            }
                            
                            resolve(fullText);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } else if (file.type.includes('text') || file.name.endsWith('.txt')) {
                    // Text files
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        resolve(e.target.result);
                    };
                    reader.readAsText(file);
                } else if (file.type.includes('document') || file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
                    // For DOC/DOCX, provide guidance
                    resolve(`[Document file detected. For best results, please save as PDF or text file, or describe your background in the chat.]`);
                } else {
                    resolve(`[Unsupported file type. Please upload PDF, DOC, DOCX, or TXT files.]`);
                }
            });
        }

        async function analyzeCVWithAI(cvText) {
            const prompt = `Analyze this CV and extract key information. Return ONLY a JSON object with this exact structure:
{
  "experience": "Summary of work experience including years and roles",
  "education": "Educational background and qualifications",
  "skills": "Key skills and competencies",
  "industry": "Primary industry or sector",
  "goals": "Inferred career goals based on CV content"
}

CV TEXT:
${cvText.substring(0, 1500)}`;
            
            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROK_API_KEYS[0]}`
                    },
                    body: JSON.stringify({
                        model: 'mixtral-8x7b-32768',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a career advisor analyzing CVs. Extract key information and return ONLY valid JSON.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.3,
                        max_tokens: 500
                    })
                });
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // Extract JSON from response
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
                
                throw new Error('No JSON found in response');
                
            } catch (error) {
                console.error('CV analysis error:', error);
                // Return default structure
                return {
                    experience: "Experience not determined from CV",
                    education: "Education not determined from CV",
                    skills: "Various skills",
                    industry: "Various industries",
                    goals: "Career advancement and development"
                };
            }
        }

        async function askForProfileVerification(profile) {
            const verificationPrompt = `Based on my analysis of your CV, I've identified:

• **Experience**: ${profile.experience}
• **Education**: ${profile.education}
• **Key Skills**: ${profile.skills}
• **Industry**: ${profile.industry}
• **Career Goals**: ${profile.goals}

Is this information accurate? Please let me know if anything needs correction, or if you'd like to add more details about your background and career objectives.`;

            addBotMessage(verificationPrompt);
            
            // Add to conversation history
            conversationHistory.push({
                role: 'assistant',
                content: verificationPrompt,
                timestamp: new Date().toISOString()
            });
        }

        function askAboutProfileCorrection() {
            const message = "I'd like to correct some details in my profile. Let me update my information.";
            document.getElementById('userInput').value = message;
            sendMessage();
        }

        async function getProgramRecommendations() {
            if (!userProfile) {
                addBotMessage("I don't have your profile information yet. Please upload your CV or tell me about your background first.");
                return;
            }
            
            addSystemMessage("Finding suitable GIBS programs for your profile...");
            
            const prompt = `Based on this user profile, recommend suitable GIBS programs and explain why they're good matches:

PROFILE:
- Experience: ${userProfile.experience}
- Education: ${userProfile.education}
- Skills: ${userProfile.skills}
- Industry: ${userProfile.industry}
- Goals: ${userProfile.goals}

Provide detailed recommendations including:
1. Specific GIBS programs that match
2. Why each program is suitable
3. Admission requirements
4. Career outcomes
5. Potential job opportunities after completion

Be specific about program names (MBA, PDBA, MPhil, DBA, etc.) and mention African business context.`;
            
            document.getElementById('userInput').value = prompt;
            sendMessage();
            
            // Scroll to recommendations section
            document.getElementById('recommendationsSection').style.display = 'block';
            setTimeout(() => {
                document.getElementById('recommendationsSection').scrollIntoView({ behavior: 'smooth' });
            }, 500);
        }

        function displayProfileSummary() {
            if (!userProfile) return;
            
            const profileSection = document.getElementById('profileSection');
            const profileContent = document.getElementById('profileContent');
            
            let html = '<div class="profile-summary">';
            html += '<div class="profile-item"><span class="profile-label">Experience:</span><span class="profile-value">' + (userProfile.experience || 'Not specified') + '</span></div>';
            html += '<div class="profile-item"><span class="profile-label">Education:</span><span class="profile-value">' + (userProfile.education || 'Not specified') + '</span></div>';
            html += '<div class="profile-item"><span class="profile-label">Skills:</span><span class="profile-value">' + (userProfile.skills || 'Various skills') + '</span></div>';
            html += '<div class="profile-item"><span class="profile-label">Industry:</span><span class="profile-value">' + (userProfile.industry || 'Various industries') + '</span></div>';
            html += '<div class="profile-item"><span class="profile-label">Career Goals:</span><span class="profile-value">' + (userProfile.goals || 'Career advancement') + '</span></div>';
            html += '</div>';
            
            profileContent.innerHTML = html;
            profileSection.style.display = 'block';
            
            // Also show recommendations section
            document.getElementById('recommendationsSection').style.display = 'block';
        }

        function loadPrograms() {
            // Since we want pure AI responses, we'll let the AI describe programs
            // But we can show a loading message
            const container = document.getElementById('programsGrid');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="loader" style="width: 40px; height: 40px; margin: 0 auto 20px;"></div>
                    <p>Loading GIBS program information...</p>
                    <p style="font-size: 14px; color: #666; margin-top: 10px;">Ask me about specific programs like MBA, PDBA, MPhil, or DBA</p>
                </div>
            `;
            
            // After a delay, show placeholder
            setTimeout(() => {
                container.innerHTML = `
                    <div class="program-card">
                        <h3>Ask About Programs</h3>
                        <p>Use the chat to ask about specific GIBS programs:</p>
                        <div class="program-tags">
                            <span class="tag">MBA</span>
                            <span class="tag">PDBA</span>
                            <span class="tag">MPhil</span>
                            <span class="tag">DBA</span>
                            <span class="tag">PhD</span>
                        </div>
                        <div class="program-actions">
                            <button class="quick-btn" onclick="quickAction('mba')">Ask about MBA</button>
                            <button class="quick-btn" onclick="quickAction('executive')">Executive Programs</button>
                        </div>
                    </div>
                    <div class="program-card">
                        <h3>Career Pathways</h3>
                        <p>Discuss career opportunities after GIBS programs:</p>
                        <div class="program-tags">
                            <span class="tag">Leadership</span>
                            <span class="tag">Consulting</span>
                            <span class="tag">Entrepreneurship</span>
                            <span class="tag">Strategy</span>
                        </div>
                        <div class="program-actions">
                            <button class="quick-btn" onclick="quickAction('career')">Career Advice</button>
                            <button class="quick-btn" onclick="quickAction('jobs')">Job Opportunities</button>
                        </div>
                    </div>
                    <div class="program-card">
                        <h3>Admissions & Costs</h3>
                        <p>Get information about requirements and financing:</p>
                        <div class="program-tags">
                            <span class="tag">Requirements</span>
                            <span class="tag">Costs</span>
                            <span class="tag">Scholarships</span>
                            <span class="tag">Application</span>
                        </div>
                        <div class="program-actions">
                            <button class="quick-btn" onclick="quickAction('admissions')">Admissions Info</button>
                            <button class="quick-btn" onclick="quickAction('cost')">Costs & Funding</button>
                        </div>
                    </div>
                `;
            }, 1000);
        }

        function analyzeResponseForActions(userMessage, botResponse) {
            const lowerMsg = userMessage.toLowerCase();
            const lowerResp = botResponse.toLowerCase();
            
            // Show career section if career-related
            if (lowerMsg.includes('career') || lowerMsg.includes('job') || lowerMsg.includes('opportunit') || 
                lowerResp.includes('career') || lowerResp.includes('job') || lowerResp.includes('opportunit')) {
                document.getElementById('careerSection').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('careerSection').scrollIntoView({ behavior: 'smooth' });
                }, 300);
            }
            
            // Show programs section if program-related
            if (lowerMsg.includes('program') || lowerMsg.includes('mba') || lowerMsg.includes('pdba') || 
                lowerMsg.includes('mphil') || lowerMsg.includes('dba') || lowerMsg.includes('phd')) {
                setTimeout(() => {
                    document.getElementById('programsSection').scrollIntoView({ behavior: 'smooth' });
                }, 300);
            }
        }

        function quickAction(action) {
            const actions = {
                'cv': "Uploading CV for analysis...",
                'programs': "Can you tell me about all the GIBS programs available? I want to understand what options I have.",
                'admissions': "What are the admission requirements for GIBS programs, and what is the application process like?",
                'career': "What kind of career opportunities and job prospects can I expect after completing a GIBS program?",
                'cost': "How much do GIBS programs cost, and what funding or scholarship options are available?",
                'mba': "Tell me about the GIBS MBA program - specializations, duration, format, and career outcomes.",
                'executive': "What executive education programs does GIBS offer for experienced professionals?",
                'jobs': "What are the typical job roles and industries that GIBS graduates enter, especially in the African context?"
            };
            
            if (action === 'cv') {
                document.getElementById('cvFileInput').click();
            } else if (actions[action]) {
                document.getElementById('userInput').value = actions[action];
                sendMessage();
            }
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                sendMessage();
            }
        }

        // Chat UI Functions
        function addUserMessage(text) {
            addMessageToChat('user', text);
        }

        function addBotMessage(text) {
            addMessageToChat('bot', text);
        }

        function addSystemMessage(text) {
            addMessageToChat('system', text);
        }

        function addMessageToChat(role, text) {
            const chatBody = document.getElementById('chatBody');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            // Format text with line breaks
            const formattedText = text.replace(/\n/g, '<br>');
            messageDiv.innerHTML = formattedText;
            
            // Add timestamp
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-info';
            timeDiv.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            messageDiv.appendChild(timeDiv);
            
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function addTypingIndicator() {
            const chatBody = document.getElementById('chatBody');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            chatBody.appendChild(typingDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
            return typingDiv;
        }

        function saveSession() {
            try {
                // Limit session size
                if (currentSession.messages.length > 50) {
                    currentSession.messages = currentSession.messages.slice(-50);
                }
                
                // Update conversation history
                conversationHistory = currentSession.messages.slice(-20);
                
                localStorage.setItem('gibs_session', JSON.stringify(currentSession));
            } catch (e) {
                console.log('Session save error (localStorage full?)');
            }
        }

        function updateMessageCount() {
            const count = currentSession.messages.length;
            document.getElementById('messageCount').textContent = count;
        }

        function clearSession() {
            if (confirm('Start a new session? Your current conversation will be cleared.')) {
                localStorage.removeItem('gibs_session');
                conversationHistory = [];
                currentSession = {
                    id: generateSessionId(),
                    messages: [],
                    profile: null,
                    cvData: null,
                    timestamp: new Date().toISOString()
                };
                userProfile = null;
                currentCVText = '';
                
                document.getElementById('chatBody').innerHTML = '';
                document.getElementById('profileSection').style.display = 'none';
                document.getElementById('recommendationsSection').style.display = 'none';
                document.getElementById('careerSection').style.display = 'none';
                
                addWelcomeMessage();
                saveSession();
            }
        }

        function exportSessionData() {
            const dataStr = JSON.stringify({
                session: currentSession,
                profile: userProfile,
                conversation: conversationHistory
            }, null, 2);
            
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `gibs-ai-session-${currentSession.id}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Make functions available globally
        window.sendMessage = sendMessage;
        window.handleKeyPress = handleKeyPress;
        window.quickAction = quickAction;
        window.getProgramRecommendations = getProgramRecommendations;
        window.askAboutProfileCorrection = askAboutProfileCorrection;
        window.exportSessionData = exportSessionData;
        window.clearSession = clearSession;
    </script>
</body>
</html>